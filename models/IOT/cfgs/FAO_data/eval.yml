loss:
  based_on: loss

# Plot the true transport map
true_transport_map:
  based_on:
    - .creator.universe
    - .matrix
  select:
    data:
      path: T
      transform: [.data]
  vmin: 1e-2
  norm: LogNorm
  cbar_kwargs:
    label: $T_{ij}$
  helpers:
    set_title:
      title: True transport map $\mathbf{T}$
  figsize: [!dag_result quarter_width, !dag_result quarter_width]

# Plot the marginals (or rather their Hadamard product)
true_marginals:
  based_on:
    - .creator.universe
    - .matrix
  select:
    true_mu:
      path: mu
      transform: [.data]
    true_nu:
      path: nu
      transform: [.data]
  transform:
    - hadamard: [!dag_tag true_mu, !dag_tag true_nu]
      tag: data
  norm: LogNorm
  vmin: 1e-2
  cbar_kwargs:
    label: $\mu_i \nu_j$
  helpers:
    set_title:
      title: True marginals $\boldsymbol{\mu} \boldsymbol{\nu}$
  figsize: [!dag_result quarter_width, !dag_result quarter_width]

# Plot the true transport map
transport_map:
  based_on:
    - .creator.universe
    - .matrix
  select:
    prediction:
      path: predicted_T
      transform:
        - .isel_with_drop: [!dag_prev , {epoch: -1}]
    true_T:
      path: T
      transform: [.data]
  transform:
    - sub: [!dag_tag true_T, !dag_tag prediction ]
    - np.abs: [!dag_prev ]
    - create_mask: [ !dag_tag true_T, '>=', 0 ]
    - xr.where: [ !dag_prev , !dag_tag prediction,  0]
    - concat_along: [[!dag_tag true_T, !dag_prev ], 'type', ['True transport plan', 'Prediction']]
      tag: data
  vmin: 1e-4
  norm: LogNorm
  col: type
  cbar_kwargs:
    label: $T_{ij}$
  figsize: [!dag_result two_thirds_width, !dag_result third_width]

# Plot the L1 error on the mode of the predicted transport plan
transport_error:
  based_on:
    - .creator.universe
    - .matrix
    - .cmap_WhYeRe
  select:
    prediction:
      path: predicted_T
    true_T:
      path: T
      transform:
        - create_mask: [ !dag_prev , '>', 0 ]
        - xr.where: [ !dag_prev , !dag_node -2,  0 ]
    loss_idx:
      path: loss
      transform:
        - .sel_with_drop: [!dag_prev , {kind: T}]
        - .idxmin: [!dag_prev ]
  transform:
    - .sel_with_drop: [!dag_tag prediction, {epoch: !dag_tag loss_idx}]
    - sub: [!dag_tag true_T, !dag_prev ]
    - np.abs: [!dag_prev ]
    - create_mask: [ !dag_tag true_T , '>', 0 ]
    - xr.where: [ !dag_prev , !dag_node -2,  0 ]
    - div: [!dag_prev , !dag_tag true_T]
      tag: data
  norm:
    name: LogNorm
#  vmin: 1e-10
  helpers:
    set_title:
      title: Relative L1 error on T [%]
  style:
    figure.figsize: [ !dag_result third_width, !dag_result third_width ]

# Plot the marginals (or rather their Hadamard product)
marginals:
  based_on:
    - .creator.universe
    - .matrix
    - .cmap_WhYeRe
  select:
    mu:
      path: predicted_mu
    nu:
      path: predicted_nu
    true_mu:
      path: mu
      transform: [.data]
    true_nu:
      path: nu
      transform: [.data]
    loss_idx:
      path: loss
      transform:
        - .sel_with_drop: [!dag_prev , {kind: T}]
        - .idxmin: [!dag_prev ]
  transform:
    - .sel_with_drop: [!dag_tag mu, {epoch: !dag_tag loss_idx}]
      tag: pred_mu
    - .sel_with_drop: [!dag_tag nu, {epoch: !dag_tag loss_idx}]
      tag: pred_nu
    - hadamard: [!dag_tag true_mu, !dag_tag true_nu]
    - create_mask: [ !dag_prev , '>', 0 ]
    - xr.where: [ !dag_prev , !dag_node -2,  0 ]
    - hadamard: [!dag_tag pred_mu, !dag_tag pred_nu]
    - xr.where: [ !dag_node -3 , !dag_prev ,  0 ]
    - concat_along: [[!dag_node -3 , !dag_prev ], 'type', ['True marginals', 'Prediction']]
      tag: data
  col: type
  vmin: 1e-7
  norm: LogNorm
  cbar_kwargs:
    label: $\mu_i \nu_j$
  figsize: [!dag_result two_thirds_width, !dag_result third_width]

cost_over_time:
  based_on:
    - .creator.multiverse
    - .plot.facet_grid.errorbands
    - .plot.facet_grid.with_auto_encoding
  select_and_combine:
    fields:
      prediction:
        path: predicted_C
        transform:
          - .sel_with_drop: [!dag_prev , {j: 'UK', i: ['Netherlands', 'Spain', 'Morocco']}]
      loss:
        path: loss
        transform:
          - .sel_with_drop: [!dag_prev , {kind: T}]
  transform:
    - .median: [!dag_tag loss, 'epoch']
    - div: [!dag_tag loss, !dag_prev ]
    - neg_exp: [!dag_prev ]
      tag: probability
    - broadcast: [!dag_tag prediction, !dag_prev ]
    - marginal_from_ds: [!dag_prev ]
      kwargs: {x: x, y: loss, along_dim: [epoch]}
      tag: marginal
    - mean: [!dag_prev ]
      kwargs: {x: x, y: y, along_dim: [bin_idx]}
    - getitem: [!dag_prev , 'mean']
      tag: mean
    - std: [!dag_tag marginal]
      kwargs: {x: x, y: y, along_dim: [bin_idx]}
    - getitem: [ !dag_prev , 'std' ]
      tag: std
    - xr.Dataset:
      - y: !dag_tag mean
        yerr: !dag_tag std
      tag: data
  x: time_isel
  y: y
  yerr: yerr
  helpers:
    set_labels:
      x: Year
      y: Relative import cost
    set_legend:
      title: 'Origin'
    set_title:
      title: Tomato import cost to UK
    set_ticks:
      x:
        major:
          locs: [-1, -2, -3, -4, -5]
          labels: [2021, 2020, 2019, 2018, 2017]
  style:
    figure.figsize: [!dag_result half_width, !dag_result half_width]